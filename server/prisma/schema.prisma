// --- Configuration Prisma ---
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Modèles de Données ---

/// Modèle Ecole
/// Représente un établissement scolaire dans le système.
model School {
  id        String   @id @default(uuid())
  name      String   // Nom de l'école
  address   String?  // Adresse physique
  isActive  Boolean  @default(true) // Permet de suspendre l'accès à une école
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Gestionnaire de l'école
  managerId String?  @unique
  manager   User?    @relation("SchoolManager", fields: [managerId], references: [id])

  // Relations
  users         User[] @relation("SchoolUsers")
  classes       Class[]
  subjects      Subject[]
  academicYears AcademicYear[]
}

/// Modèle Utilisateur
/// Gère tous les profils (Super Admin, Admin Ecole, Prof, Elève).
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // Mot de passe crypté (Haché)
  firstName String
  lastName  String
  role      String   @default("STUDENT") // SUPER_ADMIN, SCHOOL_ADMIN, TEACHER, STUDENT, IT_ADMIN
  isOnline  Boolean  @default(false)
  // Relation avec l'école (Optionnel pour le Super Admin)
  schoolId  String?
  school    School?  @relation("SchoolUsers", fields: [schoolId], references: [id], onDelete: SetNull)

  // Si l'utilisateur est un gestionnaire d'école
  managedSchool School? @relation("SchoolManager")

  // Relations spécifiques
  courses      Course[]      // Si l'utilisateur est un professeur
  enrollments  Enrollment[]  // Si l'utilisateur est un élève
  grades       Grade[]       // Notes obtenues par l'élève
  submissions  Submission[]  // Devoirs rendus par l'élève
  quizAttempts QuizAttempt[] // Tentatives de quiz
  
  // Messagerie
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/// Modèle Année Scolaire
/// Définit les périodes de cours pour une école.
model AcademicYear {
  id        String   @id @default(uuid())
  name      String   // ex: "2023-2024"
  startDate DateTime
  endDate   DateTime
  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  terms     Term[]   // Trimestres ou semestres
}

/// Modèle Trimestre / Période
/// Gère le découpage de l'année scolaire.
model Term {
  id             String     @id @default(uuid())
  name           String     // ex: "Trimestre 1"
  startDate      DateTime
  endDate        DateTime
  status         String     @default("OPEN") // Statut : OPEN (ouvert aux notes) ou CLOSED
  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  grades         Grade[]
}

/// Modèle Classe
model Class {
  id        String   @id @default(uuid())
  name      String   // ex: "Terminale S1"
  level     String?  // ex: "Lycée"
  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  enrollments Enrollment[]
  courses     Course[]
  messages    Message[]
}

/// Modèle Matière
model Subject {
  id        String   @id @default(uuid())
  name      String   // ex: "Mathématiques"
  code      String?  // ex: "MATH01"
  schoolId  String
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  courses   Course[]
}

/// Modèle Inscription
/// Lie un élève à une classe pour une période donnée.
model Enrollment {
  id        String   @id @default(uuid())
  studentId String
  student   User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  classId   String
  class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  joinedAt  DateTime @default(now())
}

/// Modèle Cours
/// Représente l'assignation d'un prof à une matière dans une classe.
model Course {
  id        String   @id @default(uuid())
  classId   String
  class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  subjectId String
  subject   Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacherId String
  teacher   User     @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  coefficient Int    @default(1) // Importance de la matière pour la moyenne

  materials    Material[]
  assignments  Assignment[]
  quizzes      Quiz[]
  chapters     Chapter[]
}

model Chapter {
  id        String   @id @default(uuid())
  title     String
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  materials Material[]
  createdAt DateTime @default(now())
}

/// Modèle Support de Cours
model Material {
  id        String   @id @default(uuid())
  title     String
  type      String   // ex: "PDF", "VIDEO", "LINK"
  url       String   // Lien vers le fichier (Supabase Storage)
  source    String?  // Source du document (ex: "Manuel page 12", "Youtube")
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  chapterId String?
  chapter   Chapter? @relation(fields: [chapterId], references: [id])
  createdAt DateTime @default(now())
}

/// Modèle Devoir
model Assignment {
  id          String   @id @default(uuid())
  title       String
  description String?
  dueDate     DateTime
  points      Int      @default(20)
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  submissions Submission[]
  grades      Grade[]
  createdAt   DateTime @default(now())
}

/// Modèle Rendu de Devoir
model Submission {
  id           String   @id @default(uuid())
  content      String?  // Texte ou commentaire
  fileUrl      String?  // URL du fichier rendu
  submittedAt  DateTime @default(now())
  studentId    String
  student      User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  assignmentId String
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  
  grade        Grade?   // Note associée à ce rendu
}

/// Modèle Note
model Grade {
  id           String      @id @default(uuid())
  value        Float       // La note brute (ex: 15.5)
  comment      String?
  studentId    String
  student      User        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  termId       String?
  term         Term?       @relation(fields: [termId], references: [id])
  assignmentId String?
  assignment   Assignment? @relation(fields: [assignmentId], references: [id])
  submissionId String?     @unique
  submission   Submission? @relation(fields: [submissionId], references: [id])
  
  createdAt    DateTime    @default(now())
}

/// Modèle Message (Messagerie Instantanée)
model Message {
  id          String   @id @default(uuid())
  content     String
  senderId    String
  sender      User     @relation("SentMessages", fields: [senderId], references: [id])
  recipientId String?  // Si message privé
  recipient   User?    @relation("ReceivedMessages", fields: [recipientId], references: [id])
  classId     String?  // Si message de groupe (classe)
  class       Class?   @relation(fields: [classId], references: [id])
  
  attachmentUrl  String? // URL d'un fichier joint
  attachmentType String? // Type de fichier joint

  createdAt   DateTime @default(now())
}

/// Modèles Quiz et Évaluations
model Quiz {
  id          String   @id @default(uuid())
  title       String
  description String?
  published   Boolean  @default(false)
  timeLimit   Int?     // En minutes
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  questions   QuizQuestion[]
  attempts    QuizAttempt[]
  createdAt   DateTime @default(now())
}

model QuizQuestion {
  id          String   @id @default(uuid())
  text        String
  type        String   @default("MULTIPLE_CHOICE")
  points      Int      @default(1)
  quizId      String
  quiz        Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  
  options     QuizOption[]
  answers     QuizAnswer[]
  correctAnswer String // Texte de la réponse correcte pour simplifier
}

model QuizOption {
  id          String   @id @default(uuid())
  text        String
  isCorrect   Boolean  @default(false)
  questionId  String
  question    QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model QuizAttempt {
  id          String   @id @default(uuid())
  score       Float
  startedAt   DateTime @default(now())
  completedAt DateTime @default(now())
  studentId   String
  student     User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  quizId      String
  quiz        Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  answers     QuizAnswer[]
}

model QuizAnswer {
  id              String   @id @default(uuid())
  attemptId       String
  attempt         QuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  questionId      String
  question        QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  selectedOptions String[] // IDs des options sélectionnées
  isCorrect       Boolean
}

/// Modèle Notification
model Notification {
  id        String   @id @default(uuid())
  title     String
  message   String
  userId    String?  // ID de l'utilisateur cible
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
}
